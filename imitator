using System;
using System.Collections.Generic;
using System.Linq;
using Elgsis.DP.Protocols.Dlms.Cosem;
using Elgsis.DP.Protocols.Dlms.Cosem.IC;
using Elgsis.DP.Protocols.Asn;
using Elgsis.DP;
using Elgsis.Virtual.Device.Dlms;

namespace VirtualDevs.Device.Dlms
{
    struct GeneratorColumn
    {
        public readonly CaptureObjectDefinition Cod;
        public readonly Func<double, object> func;

        public GeneratorColumn(CaptureObjectDefinition cod, Func<double, object> func)
        {
            this.Cod = cod;
            this.func = func;
        }
    }

    class ProfileClassImitator : IAttributesHandler
    {
        private readonly Func<DateTimeOffset> timeSource;
        private readonly ITableGenerator tableGenerator;
        private readonly TimeSpan capturePeriod;
        private readonly UInt32 profileEntries;
        private readonly DateTimeOffset firstEntryTime;

        //private readonly long capturePeriodInTicks;
        //private readonly uint entriesInUse;
        //private readonly int numberOfCaptures;
        //private readonly DateTimeOffset lastCaptureTime;

        public ProfileClassImitator(
            Func<DateTimeOffset> timeSource,
            ITableGenerator tableGenerator,
            TimeSpan capturePeriod,
            UInt32 profileEntries,
            DateTimeOffset firstEntryTime
            )
        {
            this.tableGenerator = tableGenerator ?? throw new ArgumentNullException(nameof(tableGenerator)); //ITableGenerator
            this.timeSource = timeSource ?? throw new ArgumentNullException(nameof(timeSource));
            this.profileEntries = profileEntries;
            this.capturePeriod = capturePeriod;
            this.firstEntryTime = firstEntryTime;

            //this.capturePeriodInTicks = TimeSpan.FromSeconds(capturePeriod).Ticks;
            //this.numberOfCaptures = CalcNumOfCaptures(capturePeriodInTicks, timeSource);
            //this.lastCaptureTime = CalcLastCaptureTime(numberOfCaptures, capturePeriodInTicks, timeSource);
            //this.entriesInUse = CalcEntriesInUse(timeSource(), lastCaptureTime, capturePeriod);
        }
        public Func<DateTimeOffset> TimeSource { get { return timeSource; } }

        public ITableGenerator TableGenerator { get { return tableGenerator; } }

        public string CapturePeriod { get { return capturePeriod.ToString(); } } 

        public UInt32 ProfileEntries { get { return profileEntries; } }

        public int ClassId => throw new NotImplementedException();

        public Func<SelectiveAccess?, Data>[] AttributesHandlers
        {
            get
            {
                return new Func<SelectiveAccess?, Data>[]
                {
                         x => throw new NotImplementedException(),
                         GetData,
                         GetCaptureObjects,
                         GetCapturePeriod,
                         null,
                         null,
                         GetEntryInUse,
                         GetprofileEntries
                };
            }
        }

        public Data GetCaptureObjects(SelectiveAccess? selective)
        {
            //Time?
            var listCapObjDef = new List<CaptureObjectDefinition>();
            listCapObjDef.Add(new CaptureObjectDefinition(8, ObisCode.Parse("0100010000FF"), 2, 0));

            foreach( var col in tableGenerator.GeneratorColumns)
            {
                listCapObjDef.Add(col.Cod);
            }

            return DataCoder.Encode(listCapObjDef.ToArray());
        }

        public Data GetCapturePeriod(SelectiveAccess? selective)
        {
            return DataCoder.Encode(capturePeriod.ToString());
        }

        public Data GetprofileEntries(SelectiveAccess? selective)
        {
            return DataCoder.Encode(profileEntries);
        }

        public Data GetEntryInUse(SelectiveAccess? selective)
        {
            return DataCoder.Encode(tableGenerator.GetEntriesInUse(timeSource(), firstEntryTime, capturePeriod));
        }

        public Data GetData(SelectiveAccess? access)
        {
            ValidateSelectiveAccess(access);

            var entry = (EntryDescriptor)access.Value.Descriptor;

            if (entry.FromEntry == 0)
                return DataCoder.Encode(new Data[] { });

            return tableGenerator.GenerateTable(entry, timeSource(), firstEntryTime, capturePeriod);
        }

        private void ValidateSelectiveAccess(SelectiveAccess? access)
        {
            if (!access.HasValue)
                throw new NotImplementedException();

            if (access.Value.Index != 1)
                throw new NotImplementedException();
        }
    }
}
